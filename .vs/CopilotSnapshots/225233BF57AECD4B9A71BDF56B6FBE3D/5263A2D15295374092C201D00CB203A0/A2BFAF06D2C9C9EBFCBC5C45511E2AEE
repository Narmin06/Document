using AcceptanceDocuments.Business.DTOs;
using AcceptanceDocuments.Business.DTOs.DocumentDTO;
using AcceptanceDocuments.Business.DTOs.DocumentFieldValueDTO;
using AcceptanceDocuments.Business.Services.Interfaces;
using AcceptanceDocuments.Dal.Data;
using AcceptanceDocuments.Domain.Models;
using Microsoft.EntityFrameworkCore;
namespace AcceptanceDocuments.Business.Services.Implements;

public class DocumentService : IDocumentService
{
    private readonly IUnitOfWork _unitOfWork;
    private readonly IFileService _fileService;

    public DocumentService(IUnitOfWork unitOfWork, IFileService fileService)
    {
        _unitOfWork = unitOfWork;
        _fileService = fileService;
    }

    public async Task CreateAsync(DocumentCreateRequestDTO documentDto, CancellationToken cancellationToken = default)
    {
        if (documentDto == null)
            throw new ArgumentNullException(nameof(documentDto));

        var filePath = await _fileService.UploadFileAsync(documentDto.File, cancellationToken);

        var documentType = await _unitOfWork.Repository<DocumentType>().GetByIdAsync(documentDto.DocumentTypeId, cancellationToken);
        if (documentType == null)
            throw new KeyNotFoundException($"DocumentType with id {documentDto.DocumentTypeId} not found.");

        var document = new Documentt
        {
            DocumentCode = Guid.NewGuid().ToString(),
            DocumentNumber = documentDto.DocumentNumber ?? "",
            DocumentTypeId = documentDto.DocumentTypeId,
            DocumentDate = documentDto.DocumentDate,
            CreateTime = DateTime.UtcNow,
            Note = documentDto.Note,
            FilePathUrl = filePath
        };

        _unitOfWork.Repository<Documentt>().Create(document);

        if (documentDto.FieldValues != null)
        {
            foreach (var fieldValue in documentDto.FieldValues)
            {
                var documentFieldValue = new DocumentFieldValue
                {
                    Value = fieldValue.Value,
                    DocumentId = document.Id,
                    DocumentFieldDefinitionId = fieldValue.DocumentFieldDefinitionId
                };

                _unitOfWork.Repository<DocumentFieldValue>().Create(documentFieldValue);
            }
        }

        await _unitOfWork.SaveChangesAsync(cancellationToken);
    }

    public async Task DeleteAsync(Guid id, CancellationToken cancellationToken = default)
    {
        var document = await _unitOfWork.Repository<Documentt>().GetByIdAsync(id);

        if (document is null)
            throw new KeyNotFoundException($"Document with id {id} not found.");

        _unitOfWork.Repository<Documentt>().Delete(document);
        await _unitOfWork.SaveChangesAsync(cancellationToken);
    }

    public async Task<PagedResult<DocumentAdminResponseDTO>> GetAllAsync(DocumentQueryDTO dto, CancellationToken cancellationToken = default)
    {
        IQueryable<Documentt> query = _unitOfWork.Repository<Documentt>().GetAll(includes: x => x.Include(document => document.DocumentType)
                                                                                                 .Include(document => document.FieldValues));

        string name = query.Where(x => x.DocumentTypeId == x.DocumentType.Id).Select(x => x.DocumentType.Name).FirstOrDefault() ?? string.Empty;

        if (dto is null)
            throw new ArgumentNullException(nameof(dto));

        if (dto.CreatedFrom.HasValue)
            query = query.Where(x => x.CreateTime >= dto.CreatedFrom.Value);

        if (dto.CreatedTo.HasValue)
            query = query.Where(x => x.CreateTime <= dto.CreatedTo.Value);

        if (!string.IsNullOrEmpty(dto.Search))
            query = query.Where(x => x.DocumentNumber.Contains(dto.Search));

        if (dto.CreatedFrom.HasValue)
            query = query.Where(x => x.CreateTime >= dto.CreatedFrom.Value);

        if (dto.CreatedTo.HasValue)
            query = query.Where(x => x.CreateTime <= dto.CreatedTo.Value);

        int pageNumber = dto.PageNumber <= 0 ? 1 : dto.PageNumber;
        int pageSize = dto.PageSize <= 0 ? 10 : dto.PageSize;

        var pagedResult = await query.ToPagedResultAsync(pageNumber, pageSize, cancellationToken);

        var dtoItems = pagedResult.Items.Select(document => new DocumentAdminResponseDTO
        {
            Id = document.Id,
            DocumentCode = document.DocumentCode,
            DocumentNumber = document.DocumentNumber,
            DocumentTypeName = name,
            DocumentDate = document.DocumentDate,
            CreateTime = document.CreateTime,
            IsActive = document.IsActive,
            IsDeleted = document.IsDeleted,
            Note = document.Note ?? "",
            FileUrl = document.FilePathUrl,
            FieldValues = document.FieldValues?.Select(fv => new DocumentFieldValueResponseDTO
            {
                DocumentFieldDefinitionId = fv.DocumentFieldDefinitionId,
                FieldDefinitionName = fv.DocumentFieldDefinition?.Label ?? string.Empty,
                Value = fv.Value ?? string.Empty
            }) ?? new List<DocumentFieldValueResponseDTO>()
        }).ToList();

        return new PagedResult<DocumentAdminResponseDTO>
        {
            Items = dtoItems,
            PageNumber = pagedResult.PageNumber,
            PageSize = pagedResult.PageSize,
            TotalCount = pagedResult.TotalCount
        };
    }

    public async Task<PagedResult<DocumentResponseDTO>> GetAllModeratorAsync(DocumentQueryDTO dto, CancellationToken cancellationToken = default)
    {
        IQueryable<Documentt> query = _unitOfWork.Repository<Documentt>().GetAll(includes: x => x.Include(document => document.DocumentType)
                                                                                                 .Include(document => document.FieldValues), filter: x => x.IsActive);

        string name = query.Where(x => x.DocumentTypeId == x.DocumentType.Id).Select(x => x.DocumentType.Name).FirstOrDefault() ?? string.Empty;


        if (dto is null)
            throw new ArgumentNullException(nameof(dto));

        if (dto.CreatedFrom.HasValue)
            query = query.Where(x => x.CreateTime >= dto.CreatedFrom.Value);

        if (dto.CreatedTo.HasValue)
            query = query.Where(x => x.CreateTime <= dto.CreatedTo.Value);

        int pageNumber = dto.PageNumber <= 0 ? 1 : dto.PageNumber;
        int pageSize = dto.PageSize <= 0 ? 10 : dto.PageSize;
        var pagedResult = await query.ToPagedResultAsync(pageNumber, pageSize, cancellationToken);

        var dtoItems = pagedResult.Items.Select(document => new DocumentResponseDTO
        {
            DocumentCode = document.DocumentCode,
            DocumentNumber = document.DocumentNumber,
            DocumentTypeName = name,
            DocumentDate = document.DocumentDate,
            RegsitrationDate = document.CreateTime,
            Note = document.Note ?? "",
            FileUrl = document.FilePathUrl,
            FieldValues = document.FieldValues?.Select(fv => new DocumentFieldValueResponseDTO
            {
                DocumentFieldDefinitionId = fv.DocumentFieldDefinitionId,
                FieldDefinitionName = fv.DocumentFieldDefinition?.Label ?? string.Empty,
                Value = fv.Value ?? string.Empty
            }) ?? new List<DocumentFieldValueResponseDTO>()
        }).ToList();

        return new PagedResult<DocumentResponseDTO>
        {
            Items = dtoItems,
            PageNumber = pagedResult.PageNumber,
            PageSize = pagedResult.PageSize,
            TotalCount = pagedResult.TotalCount
        };
    }

    public async Task<DocumentAdminResponseDTO> GetByIdAsync(Guid id, CancellationToken cancellationToken = default)
    {
        //var document = await _unitOfWork.Repository<Documentt>().GetByIdAsync(id);

        var document = await _unitOfWork.Repository<Documentt>().GetAsync(x => x.Id == id, includes: q => q.Include(d => d.DocumentType)
                                                                                                           .Include(d => d.FieldValues)
                                                                                                                .ThenInclude(fv => fv.DocumentFieldDefinition));


        if (document is null)
            throw new KeyNotFoundException($"Document with id {id} not found.");

        return new DocumentAdminResponseDTO
        {
            Id = document.Id,
            DocumentCode = document.DocumentCode,
            DocumentNumber = document.DocumentNumber,
            DocumentTypeName = document.DocumentType?.Name ?? "",
            DocumentDate = document.DocumentDate,
            CreateTime = document.CreateTime,
            Note = document.Note ?? "",
            FileUrl = document.FilePathUrl,
            FieldValues = document.FieldValues?.Select(fv => new DocumentFieldValueResponseDTO
            {
                DocumentFieldDefinitionId = fv.DocumentFieldDefinitionId,
                FieldDefinitionName = fv.DocumentFieldDefinition?.Label ?? string.Empty,
                Value = fv.Value ?? string.Empty
            }) ?? new List<DocumentFieldValueResponseDTO>()
        };
    }

    public async Task RecoverAsync(Guid id, CancellationToken cancellationToken = default)
    {
        var document = await _unitOfWork.Repository<Documentt>().GetByIdAsync(id);

        if (document is null)
            throw new KeyNotFoundException($"Document with id {id} not found.");

        if (document.IsDeleted)
        {
            document.IsDeleted = false;
            document.DeleteTime = null;
        }
        else
        {
            throw new Exception($"Document with id {id} is not soft deleted, so it cannot be recovered.");
        }
        await _unitOfWork.SaveChangesAsync(cancellationToken);
    }

    public async Task SoftDeleteAsync(Guid id, CancellationToken cancellationToken = default)
    {
        var document = await _unitOfWork.Repository<Documentt>().GetByIdAsync(id);

        if (document is null)
            throw new KeyNotFoundException($"Document with id {id} not found.");

        if (document.IsDeleted)
        {
            throw new Exception($"Document with id {id} is already soft deleted.");
        }
        else
        {
            document.IsDeleted = true;
            document.IsActive = false;
            document.DeleteTime = DateTime.UtcNow;
        }
        await _unitOfWork.SaveChangesAsync(cancellationToken);
    }

    public async Task ActivateAsync(Guid id, CancellationToken cancellationToken = default)
    {
        var document = await _unitOfWork.Repository<Documentt>().GetByIdAsync(id);

        if (document is null)
            throw new KeyNotFoundException($"Document with id {id} not found.");

        if (document.IsDeleted)
            throw new Exception($"Firstful Recover Document with id {id}.");

        if (document.IsActive)
        {
            throw new Exception($"Document with id {id} is already activated.");

        }

        else
        {
            document.IsActive = true;
            document.UpdateTime = DateTime.UtcNow;
        }
        await _unitOfWork.SaveChangesAsync(cancellationToken);
    }

    public async Task DeactivateAsync(Guid id, CancellationToken cancellationToken = default)
    {
        var document = await _unitOfWork.Repository<Documentt>().GetByIdAsync(id);

        if (document is null)
            throw new KeyNotFoundException($"Document with id {id} not found.");

        if (!document.IsActive)
        {
            throw new Exception($"Document with id {id} is already deactivated.");

        }

        else
        {
            document.IsActive = false;
            document.UpdateTime = DateTime.UtcNow;
        }
        await _unitOfWork.SaveChangesAsync(cancellationToken);
    }


    public async Task UpdateAsync(Guid id, DocumentUpdateRequestDTO documentDto, CancellationToken cancellationToken = default)
    {
        var document = await _unitOfWork.Repository<Documentt>().GetByIdAsync(id);

        if (document is null)
            throw new KeyNotFoundException($"Document with id {id} not found.");


        document.DocumentNumber = documentDto.DocumentNumber ?? "";
        document.DocumentDate = documentDto.DocumentDate;
        document.Note = documentDto.Note;

        if (documentDto.File != null)
        {
            if (await _fileService.FileExistsAsync(document.FilePathUrl))
            {
                await _fileService.DeleteFileAsync(document.FilePathUrl);
            }

            var filePath = await _fileService.UploadFileAsync(documentDto.File, cancellationToken);
            document.FilePathUrl = filePath;
        }

        if (documentDto.FieldValues != null)
        {
            document.FieldValues = documentDto.FieldValues.Select(fv => new DocumentFieldValue
            {
                Value = fv.Value,
                DocumentId = document.Id,
                DocumentFieldDefinitionId = fv.DocumentFieldDefinitionId
            }).ToList();
        }

        await _unitOfWork.SaveChangesAsync(cancellationToken);
    }
}
